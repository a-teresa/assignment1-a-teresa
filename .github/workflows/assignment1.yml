name: "Assignment 1 - Self-hosted tests"

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  test:
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 10

    steps:
      - name: Runner info
        shell: bash
        run: |
          set -euo pipefail
          echo "Runner: $(hostname)"
          echo "User:   $(whoami)"
          echo "WS:     ${GITHUB_WORKSPACE}"
          echo "PWD:    $(pwd)"
          git --version
          command -v cmake || true
          command -v make  || true

      - name: Clean workspace
        shell: bash
        run: |
          set -euo pipefail
          rm -rf "${GITHUB_WORKSPACE:?}/"* || true
          rm -rf "${GITHUB_WORKSPACE:?}/".[!.]* || true
          rm -rf "${GITHUB_WORKSPACE:?}/"..?* || true

      - name: Checkout repository + submodules
        shell: bash
        env:
          REPO: "${{ github.repository }}"
          SHA:  "${{ github.sha }}"
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}"

          git init
          git remote add origin "https://github.com/${REPO}.git"
          git fetch --depth 1 origin "${SHA}"
          git checkout -f "${SHA}"

          git submodule sync --recursive
          git submodule update --init --recursive --depth 1

          test -x ./full-test.sh
          test -x ./unit-test.sh
          test -f ./conf/assignment.txt

      - name: Run full-test.sh (diagnose timeout)
        shell: bash
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}"

          chmod +x ./full-test.sh ./unit-test.sh ./finder-app/*.sh || true
          rm -rf /tmp/aeld-data* || true

          echo "START: $(date -Is)"
          start=$(date +%s)

          # Use a timeout that is BELOW job timeout-minutes (10 min)
          # e.g. 9 minutes, with a hard kill 10s later if it ignores SIGTERM
          if ! timeout --foreground -k 10s 9m ./full-test.sh; then
            rc=$?
            end=$(date +%s)
            echo "FAILED (rc=$rc) after $((end-start))s at $(date -Is)"

            echo "=== tail -n 200 test.sh.log ==="
            tail -n 200 test.sh.log || true

            echo "=== ps (top offenders) ==="
            ps -eo pid,ppid,etime,cmd --sort=etime | tail -n 40 || true

            # rc=124 specifically means timeout fired
            exit "$rc"
          fi

          end=$(date +%s)
          echo "END: $(date -Is) in $((end-start))s"

      - name: Show test log (always)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          tail -n 200 test.sh.log || true
