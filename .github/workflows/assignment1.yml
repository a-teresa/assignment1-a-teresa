name: Assignment 1 - Self-hosted tests

# Do NOT cancel a running job if you push again
concurrency:
  group: assignment1-${{ github.ref }}
  cancel-in-progress: false

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  test:
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 10

    steps:
      # ------------------------------------------------------------------
      # 1. Clean workspace explicitly (important on self-hosted runners)
      # ------------------------------------------------------------------
      - name: Clean workspace
        shell: bash
        run: |
          set -euo pipefail
          echo "Cleaning workspace: $GITHUB_WORKSPACE"
          rm -rf "$GITHUB_WORKSPACE"/*
          rm -rf "$GITHUB_WORKSPACE"/.git || true

      # ------------------------------------------------------------------
      # 2. Checkout repo + submodules (THE RIGHT WAY)
      # ------------------------------------------------------------------
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          clean: true

      # ------------------------------------------------------------------
      # 3. Show runner info (debug aid)
      # ------------------------------------------------------------------
      - name: Show runner info
        shell: bash
        run: |
          set -euo pipefail
          whoami
          hostname
          uname -a
          df -h .

      # ------------------------------------------------------------------
      # 4. Ensure required tools exist
      # ------------------------------------------------------------------
      - name: Ensure realtime logging tools exist
        shell: bash
        run: |
          set -euo pipefail
          command -v timeout
          command -v stdbuf

      # ------------------------------------------------------------------
      # 5. Optional entropy helper (NON-FATAL)
      # ------------------------------------------------------------------
      - name: (Optional) Start haveged if available
        shell: bash
        run: |
          set -euo pipefail
          if command -v haveged >/dev/null 2>&1; then
            echo "haveged installed"
            if sudo -n true 2>/dev/null; then
              sudo systemctl enable --now haveged || true
              systemctl is-active haveged || true
            else
              echo "No passwordless sudo, skipping haveged start"
            fi
          else
            echo "haveged not installed, skipping"
          fi

      # ------------------------------------------------------------------
      # 6. Fix script permissions
      # ------------------------------------------------------------------
      - name: Ensure scripts are executable
        shell: bash
        run: |
          set -euo pipefail
          chmod +x \
            ./full-test.sh \
            ./unit-test.sh \
            ./finder-app/writer.sh \
            ./finder-app/finder.sh || true

      # ------------------------------------------------------------------
      # 7. Run tests WITH HARD TIMEOUT + REALTIME LOGS
      # ------------------------------------------------------------------
      - name: Run full test suite
        shell: bash
        run: |
          set -euo pipefail

          echo "=== START full-test.sh ==="
          timeout 180s stdbuf -oL -eL ./full-test.sh \
            2>&1 | tee test.sh.log

          rc=${PIPESTATUS[0]}
          echo "=== END full-test.sh (rc=$rc) ==="
          exit "$rc"

      # ------------------------------------------------------------------
      # 8. Save minimal artifacts locally (no upload-artifact hang)
      # ------------------------------------------------------------------
      - name: Save minimal artifacts
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p _artifacts
          cp -f test.sh.log _artifacts/ || true
          cp -f test_result.png _artifacts/ || true
          echo "Artifacts saved in $GITHUB_WORKSPACE/_artifacts"
